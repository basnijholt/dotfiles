# hetzner-matrix

Public Matrix homeserver ([Tuwunel](https://github.com/mindroom-ai/mindroom-tuwunel), MindRoom fork) on Hetzner Cloud ARM VPS with [Cinny](https://github.com/mindroom-ai/mindroom-cinny) web client.

Users run [MindRoom](https://github.com/mindroom-ai/mindroom) locally and connect to this server.

## Deploy

From `~/dotfiles/configs/nixos`:

```bash
# 1. Create .env with your Hetzner Cloud API token
echo "HCLOUD_TOKEN=your-token" > hosts/hetzner-matrix/.env

# 2. Push config changes (deploy uses GitHub flake)
git -C ~/dotfiles push

# 3. Deploy (two-stage: bootstrap first, then full host config)
./hosts/hetzner-matrix/deploy.py deploy hetzner-matrix --bootstrap hetzner-bootstrap --type cax21 --location nbg1
```

If a previous failed server already exists, recreate it:

```bash
./hosts/hetzner-matrix/deploy.py deploy hetzner-matrix --bootstrap hetzner-bootstrap --delete --type cax21 --location nbg1
```

## Post-deploy setup

### DNS

Create A records pointing to the server IP:
- `mindroom.chat` - website + Matrix `.well-known` delegation
- `chat.mindroom.chat` - Cinny web client

### Tuwunel config (Nix-managed)

Tuwunel TOML is generated by Nix from:

`hosts/hetzner-matrix/default.nix`

Runtime uses:

- `server_name = "mindroom.chat"`
- Matrix API on `https://mindroom.chat/_matrix/*`
- Well-known delegation on `https://mindroom.chat/.well-known/matrix/*`

Important: changing `server_name` on an existing Tuwunel database is not supported. Set this before first real use, or wipe/recreate the Matrix database first.

### Tuwunel binary (GitHub release)

Tuwunel is pinned from a GitHub release asset in Nix (`default.nix`):

- `tuwunelVersion`
- `tuwunelArchive` URL/hash

To update:

1. Change `tuwunelVersion`.
2. Update `hash` with:

```bash
nix store prefetch-file --json "https://github.com/mindroom-ai/mindroom-tuwunel/releases/download/<tag>/tuwunel-<tag>-linux-aarch64.tar.gz"
```

3. Rebuild:

```bash
nixos-rebuild switch --flake ~/dotfiles/configs/nixos#hetzner-matrix
```

### Registration + SSO secrets (agenix)

Secrets are stored as encrypted `.age` files in:

`hosts/hetzner-matrix/secrets/`

Current managed secrets:

- `registration-token.age`
- `sso-google-secret.age`
- `sso-github-secret.age`
- `sso-apple-secret.age`

To edit a secret:

```bash
cd ~/dotfiles/configs/nixos/hosts/hetzner-matrix/secrets
nix run github:ryantm/agenix -- -e registration-token.age
```

Repeat with the target `*.age` file.

Set callback URLs to:

```text
https://mindroom.chat/_matrix/client/unstable/login/sso/callback/<client_id>
```

Provider IDs and callback URLs are in Nix config, while client secrets are read from decrypted agenix files at runtime.

### Cinny web client

Build and deploy the MindRoom Cinny fork:

```bash
cd /var/www/cinny
git clone https://github.com/mindroom-ai/mindroom-cinny . || true
git pull --ff-only
npm ci
npm run build
```

### mindroom.chat website

Deploy your apex website to:

`/var/www/mindroom`

Caddy serves this directory for `https://mindroom.chat`, except for `/.well-known/matrix/server` and `/.well-known/matrix/client`, which are handled directly for Matrix delegation.

### ZFS host ID

After first deploy, generate a unique host ID and update `default.nix`:

```bash
head -c4 /dev/urandom | od -A none -t x4 | tr -d " "
```

## Rebuild

For NixOS config changes:

```bash
nixos-rebuild switch --flake ~/dotfiles/configs/nixos#hetzner-matrix
```

## Destroy

```bash
./hosts/hetzner-matrix/deploy.py destroy hetzner-matrix
```
